stages:
  - build
  - deploy

# =========================
#  FRONTEND BUILD (Next.js)
# =========================
build-frontend:
  stage: build
  tags:
    - proxmox-deploy
  script:
    - echo "Building Next.js frontend..."
    - cd "$CI_PROJECT_DIR/app"
    # Install dependencies (using clean reproducible install)
    - npm ci
    # Inject environment variables from GitLab CI/CD
    - echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" > .env.production
    - echo "Building for production..."
    - npm run build
    # Copy the built app to a known output directory
    - mkdir -p "$CI_PROJECT_DIR/build-output/frontend"
    - cp -r .next package.json next.config.* public "$CI_PROJECT_DIR/build-output/frontend/"
  artifacts:
    paths:
      - ./build-output/frontend/
  cache:
    key: frontend-${CI_COMMIT_REF_SLUG}
    paths:
      - app/node_modules/
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - app/**/*

# =========================
#  BACKEND BUILD (Go)
# =========================
build-backend:
  stage: build
  tags:
    - proxmox-deploy
  script:
    - echo "Building Go backend..."
    - cd "$CI_PROJECT_DIR/server"
    # Cache Go dependencies
    - go mod download
    - go mod tidy
    # Inject environment variables if needed
    - echo "API_MODE=$API_MODE" > .env
    # Build the binary
    - go build -o "$CI_PROJECT_DIR/build-output/backend/server"
  artifacts:
    paths:
      - ./build-output/backend/
  cache:
    key: backend-${CI_COMMIT_REF_SLUG}
    paths:
      - /go/pkg/mod
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - server/**/*

# =========================
#  FRONTEND DEPLOYMENT
# =========================
deploy-frontend:
  stage: deploy
  needs:
    - job: build-frontend
      artifacts: true
  tags:
    - proxmox-deploy
  script:
    - echo "Deploying frontend to LXC 102..."
    # 1. Stop frontend service
    - sudo /usr/sbin/pct exec 102 -- systemctl stop frontend.service
    # 2. Push the built files into the LXC
    - sudo /usr/sbin/pct push 102 "$CI_PROJECT_DIR/build-output/frontend/" /app --prune
    # 3. Set permissions
    - sudo /usr/sbin/pct exec 102 -- chmod -R 755 /app
    # 4. Restart service
    - sudo /usr/sbin/pct exec 102 -- systemctl start frontend.service
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - app/**/*

# =========================
#  BACKEND DEPLOYMENT
# =========================
deploy-backend:
  stage: deploy
  needs:
    - job: build-backend
      artifacts: true
  tags:
    - proxmox-deploy
  script:
    - echo "Deploying backend to LXC 103..."
    # 1. Stop backend service
    - sudo /usr/sbin/pct exec 103 -- systemctl stop go-backend.service
    # 2. Push compiled binary into LXC
    - sudo /usr/sbin/pct push 103 "$CI_PROJECT_DIR/build-output/backend/server" /app/server
    # 3. Ensure correct permissions
    - sudo /usr/sbin/pct exec 103 -- chmod +x /app/server
    # 4. Start backend service
    - sudo /usr/sbin/pct exec 103 -- systemctl start go-backend.service
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - server/**/*
